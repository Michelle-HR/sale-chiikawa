<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>二手交易平台</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
nav{background:#2c7be5;padding:10px 20px;display:flex;gap:20px}
nav button{background:none;border:none;color:#fff;font-size:16px;cursor:pointer}
nav button.active{font-weight:bold;text-decoration:underline}
.page{display:none;padding:20px}
.page.active{display:block}
.filter-bar{background:#fff;padding:10px;border-radius:6px;margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.card{background:#fff;padding:10px;border-radius:6px}
.card img{width:100%;height:200px;object-fit:contain;background:#eee;cursor:pointer}
.card p{margin:4px 0}
.pagination{text-align:center;margin-top:20px}
.form-box{max-width:420px;background:#fff;padding:20px;border-radius:6px}
.form-box input,.form-box select,.form-box button{width:100%;margin-top:10px;padding:8px}
#lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center}
#lightbox img{max-width:90%;max-height:90%}
</style>
</head>

<body>

<nav>
  <button id="tabList" class="active" onclick="switchPage('list')">商品列表</button>
  <button id="tabAdd" onclick="switchPage('add')">上架商品</button>
</nav>

<!-- 商品列表 -->
<div id="pageList" class="page active">
  <div class="filter-bar">
    <input id="searchName" placeholder="搜尋商品名稱">
    <input id="searchSeller" placeholder="搜尋賣家">
    <select id="filterStatus">
      <option value="">全部狀態</option>
      <option>全新未拆吊牌</option>
      <option>拆包裝有吊牌</option>
      <option>景品</option>
      <option>有污損、髒污</option>
      <option>其他狀態（私訊了解）</option>
    </select>
    <button onclick="applyFilter()">搜尋</button>
  </div>

  <div class="grid" id="items"></div>
  <div class="pagination" id="pagination"></div>
</div>

<!-- 上架商品 -->
<div id="pageAdd" class="page">
  <div class="form-box">
    <h3>上架商品</h3>

    <input id="name" placeholder="商品名稱">
    <input id="price" type="number" min="1" placeholder="價格">

    <!-- 物品狀態 -->
    <select id="status">
      <option value="">請選擇物品狀態</option>
      <option>全新未拆吊牌</option>
      <option>拆包裝有吊牌</option>
      <option>景品</option>
      <option>有污損、髒污</option>
      <option>其他狀態（私訊了解）</option>
    </select>

    <input id="seller" placeholder="賣家">
    <input id="contact" placeholder="聯繫方式">

    <input id="photo" type="file" accept="image/*" multiple>
    <small>最多 3 張，每張 ≤ 700KB</small>

    <!-- 交易地點 -->
    <select id="place">
      <option>國壽仁愛大樓</option>
      <option>國壽信義安和大樓</option>
      <option>國壽內湖大樓</option>
      <option>銀行松仁大樓</option>
      <option>證券敦南大樓</option>
      <option>另約地點</option>
    </select>

    <button onclick="addItem()">上架</button>
  </div>
</div>

<div id="lightbox" onclick="this.style.display='none'">
  <img id="lightboxImg">
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyC-uOHBAqCsdZkvqisND_0JgR5govDqMZY",
  authDomain:"sale-chiikawa.firebaseapp.com",
  projectId:"sale-chiikawa"
});
const db=firebase.firestore();

/* 管理員（方案一） */
const ADMIN_ID="ADMIN_001";
let myOwnerId=localStorage.getItem("ownerId");
if(!myOwnerId){
  myOwnerId=ADMIN_ID;
  localStorage.setItem("ownerId",myOwnerId);
}
const isAdmin=(myOwnerId===ADMIN_ID);

/* 分頁 */
const ITEMS_PER_PAGE=20;
let allItems=[],filteredItems=[];

db.collection("items").orderBy("createdAt","desc").onSnapshot(s=>{
  allItems=[];
  s.forEach(d=>allItems.push({id:d.id,...d.data()}));
  applyFilter();
});

function applyFilter(){
  const n=searchName.value.toLowerCase();
  const s=searchSeller.value.toLowerCase();
  const st=filterStatus.value;
  filteredItems=allItems.filter(i=>
    i.name.toLowerCase().includes(n)&&
    i.seller.toLowerCase().includes(s)&&
    (st===""||i.status===st)
  );
  renderPage(1);
}

function renderPage(p){
  items.innerHTML="";
  filteredItems.slice((p-1)*ITEMS_PER_PAGE,p*ITEMS_PER_PAGE).forEach(i=>{
    items.innerHTML+=`
    <div class="card">
      <img src="${i.img[0]}" onclick="openImg('${i.img[0]}')">
      <p><b>商品名稱：</b>${i.name}</p>
      <p><b>價格：</b>$${i.price}</p>
      <p><b>物品狀態：</b>${i.status}</p>
      <p><b>賣家：</b>${i.seller}</p>
      <p><b>聯繫方式：</b>${i.contact}</p>
      <p><b>交易地點：</b>${i.place}</p>
      ${(isAdmin||i.ownerId===myOwnerId)?`<button onclick="removeItem('${i.id}')">下架</button>`:""}
    </div>`;
  });
  pagination.innerHTML="";
  const pages=Math.ceil(filteredItems.length/ITEMS_PER_PAGE);
  for(let i=1;i<=pages;i++){
    pagination.innerHTML+=`<button onclick="renderPage(${i})">${i}</button>`;
  }
}

function addItem(){
  const files=[...photo.files];
  if(name.value.trim()===""||price.value===""||status.value===""||
     seller.value.trim()===""||contact.value.trim()===""||files.length===0){
    alert("請填寫所有欄位");return;
  }
  if(files.length>3){alert("最多只能上傳 3 張圖片");return;}
  const imgs=[];let loaded=0;
  files.forEach(f=>{
    const r=new FileReader();
    r.onload=()=>{
      imgs.push(r.result);loaded++;
      if(loaded===files.length){
        db.collection("items").add({
          name:name.value.trim(),
          price:Number(price.value),
          status:status.value,
          seller:seller.value.trim(),
          contact:contact.value.trim(),
          place:place.value,
          img:imgs,
          ownerId:myOwnerId,
          createdAt:firebase.firestore.FieldValue.serverTimestamp()
        }).then(()=>{alert("上架成功");switchPage("list")});
      }
    };
    r.readAsDataURL(f);
  });
}

function removeItem(id){if(confirm("確定下架？"))db.collection("items").doc(id).delete();}
function openImg(s){lightboxImg.src=s;lightbox.style.display="flex";}
function switchPage(p){
  pageList.classList.remove("active");pageAdd.classList.remove("active");
  tabList.classList.remove("active");tabAdd.classList.remove("active");
  if(p==="list"){pageList.classList.add("active");tabList.classList.add("active")}
  else{pageAdd.classList.add("active");tabAdd.classList.add("active")}
}
</script>

</body>
</html>
