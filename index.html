<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>äºŒæ‰‹äº¤æ˜“å¹³å°</title>

  <!-- Firebase SDKï¼ˆCDN + compatï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: flex;
      gap: 20px;
    }
    .box {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      width: 50%;
    }
    input, select, button {
      width: 100%;
      margin-top: 8px;
      padding: 6px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      background: #2c7be5;
      color: #fff;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #1a68d1;
    }
    small {
      color: #666;
      display: block;
      margin-top: 4px;
    }
    img {
      width: 100%;
      max-height: 200px;
      object-fit: cover;
      margin-bottom: 6px;
      border-radius: 4px;
    }
    .item {
      border-bottom: 1px solid #ddd;
      margin-bottom: 12px;
      padding-bottom: 12px;
    }
  </style>
</head>

<body>

<h1>ğŸ›’ äºŒæ‰‹äº¤æ˜“ç¶²ç«™</h1>

<div class="container">

  <!-- ä¸Šæ¶å•†å“ -->
  <div class="box">
    <h3>ä¸Šæ¶å•†å“</h3>

    <input type="text" id="name" placeholder="å•†å“åç¨±">
    <input type="number" id="price" placeholder="åƒ¹æ ¼">
    <input type="text" id="seller" placeholder="è³£å®¶åå­—">
    <input type="text" id="contact" placeholder="è¯ç¹«æ–¹å¼ï¼ˆLine / Emailï¼‰">

    <input type="file" id="photo" accept="image/*">
    <small>ğŸ“Œ åœ–ç‰‡éœ€å°æ–¼ <b>700KB</b>ï¼ˆé¿å…ç„¡æ³•ä¸Šæ¶ï¼‰</small>

    <select id="place">
      <option>åœ‹å£½ä»æ„›å¤§æ¨“</option>
      <option>åœ‹å£½ä¿¡ç¾©å®‰å’Œå¤§æ¨“</option>
      <option>åœ‹å£½å…§æ¹–å¤§æ¨“</option>
      <option>éŠ€è¡Œæ¾ä»å¤§æ¨“</option>
      <option>è­‰åˆ¸æ•¦å—å¤§æ¨“</option>
    </select>

    <button onclick="addItem()">ä¸Šæ¶</button>
  </div>

  <!-- å•†å“åˆ—è¡¨ -->
  <div class="box">
    <h3>å•†å“åˆ—è¡¨</h3>
    <div id="items"></div>
  </div>

</div>

<!-- æ‰€æœ‰ JS ä¸€å®šæ”¾åœ¨ body æœ€å¾Œ -->
<script>
  /* ===== Firebase åˆå§‹åŒ– ===== */
  const firebaseConfig = {
    apiKey: "AIzaSyC-uOHBAqCsdZkvqisND_0JgR5govDqMZY",
    authDomain: "sale-chiikawa.firebaseapp.com",
    projectId: "sale-chiikawa",
    storageBucket: "sale-chiikawa.appspot.com",
    messagingSenderId: "22981104406",
    appId: "1:22981104406:web:7c094b64fc1877c6d1f637"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const itemsBox = document.getElementById("items");

  /* ===== æ–°å¢å•†å“ï¼ˆå«åœ–ç‰‡å¤§å°é™åˆ¶ï¼‰ ===== */
  function addItem() {
    const name = document.getElementById("name").value.trim();
    const price = document.getElementById("price").value;
    const seller = document.getElementById("seller").value.trim();
    const contact = document.getElementById("contact").value.trim();
    const place = document.getElementById("place").value;
    const photoInput = document.getElementById("photo");

    if (!name || !price || !seller || !contact || !photoInput.files[0]) {
      alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
      return;
    }

    const file = photoInput.files[0];

    /* ğŸ”’ æª”æ¡ˆå¤§å°é™åˆ¶ï¼ˆ700KBï¼‰ */
    const MAX_SIZE = 700 * 1024;
    if (file.size > MAX_SIZE) {
      alert(
        "âŒ åœ–ç‰‡å¤ªå¤§ï¼Œç„¡æ³•ä¸Šæ¶\n\n" +
        "è«‹é¸æ“‡å°æ–¼ 700KB çš„åœ–ç‰‡\n" +
        "ç›®å‰å¤§å°ï¼š" + Math.round(file.size / 1024) + " KB"
      );
      photoInput.value = "";
      return;
    }

    const reader = new FileReader();
    reader.onload = function () {
      const base64 = reader.result;

      /* ğŸ” Base64 å†æ¬¡ä¿éšªï¼ˆé¿å… Firestore 1MB é™åˆ¶ï¼‰ */
      const estimatedBytes = Math.ceil(base64.length * 0.75);
      if (estimatedBytes > 1024 * 1024) {
        alert("âŒ åœ–ç‰‡è½‰æ›å¾Œä»è¶…é 1MBï¼Œè«‹ä½¿ç”¨æ›´å°åœ–ç‰‡");
        return;
      }

      db.collection("items")
        .add({
          name,
          price,
          seller,
          contact,
          place,
          img: base64,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          alert("âœ… å•†å“å·²æˆåŠŸä¸Šæ¶");

          document.getElementById("name").value = "";
          document.getElementById("price").value = "";
          document.getElementById("seller").value = "";
          document.getElementById("contact").value = "";
          document.getElementById("photo").value = "";
        })
        .catch(err => {
          alert("âŒ Firestore éŒ¯èª¤ï¼š" + err.message);
          console.error(err);
        });
    };

    reader.readAsDataURL(file);
  }

  /* ===== å³æ™‚åŒæ­¥é¡¯ç¤ºå•†å“ ===== */
  db.collection("items")
    .orderBy("createdAt", "desc")
    .onSnapshot(snapshot => {
      itemsBox.innerHTML = "";
      snapshot.forEach(doc => {
        const i = doc.data();
        itemsBox.innerHTML += `
          <div class="item">
            <img src="${i.img}">
            <b>${i.name}</b><br>
            åƒ¹æ ¼ï¼š$${i.price}<br>
            è³£å®¶ï¼š${i.seller}<br>
            è¯ç¹«æ–¹å¼ï¼š${i.contact}<br>
            äº¤æ˜“åœ°é»ï¼š${i.place}<br>
          </div>
        `;
      });
    });
</script>

</body>
</html>
