<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>äºŒæ‰‹äº¤æ˜“å¹³å°</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f5f5f5}
nav{background:#2c7be5;padding:10px 20px;display:flex;gap:20px}
nav button{background:none;border:none;color:#fff;font-size:16px;cursor:pointer}
nav button.active{font-weight:bold;text-decoration:underline}
.page{display:none;padding:20px}
.page.active{display:block}
.filter-bar{background:#fff;padding:10px;border-radius:6px;margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.card{background:#fff;padding:10px;border-radius:6px}
.card img{width:100%;height:200px;object-fit:contain;background:#eee;cursor:pointer}
.card p{margin:4px 0}
.pagination{text-align:center;margin-top:20px}
.form-box{max-width:420px;background:#fff;padding:20px;border-radius:6px}
.form-box input,.form-box select,.form-box button{width:100%;margin-top:10px;padding:8px}
.form-box small{display:block;color:#666;font-size:12px}
#lightbox{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:center}
#lightbox img{max-width:90%;max-height:90%}
</style>
</head>

<body>

<nav>
  <button id="tabList" class="active" onclick="switchPage('list')">å•†å“åˆ—è¡¨</button>
  <button id="tabAdd" onclick="switchPage('add')">ä¸Šæ¶å•†å“</button>
</nav>

<!-- å•†å“åˆ—è¡¨ -->
<div id="pageList" class="page active">
  <div class="filter-bar">
    <input id="searchName" placeholder="æœå°‹å•†å“åç¨±">
    <input id="searchSeller" placeholder="æœå°‹è³£å®¶">
    <select id="filterStatus">
      <option value="">å…¨éƒ¨ç‹€æ…‹</option>
      <option>å…¨æ–°æœªæ‹†åŠç‰Œ</option>
      <option>æ‹†åŒ…è£æœ‰åŠç‰Œ</option>
      <option>æ™¯å“</option>
      <option>æœ‰æ±¡æã€é«’æ±¡</option>
      <option>å…¶ä»–ç‹€æ…‹ï¼ˆç§è¨Šäº†è§£ï¼‰</option>
    </select>
    <button onclick="applyFilter()">æœå°‹</button>
  </div>

  <div class="grid" id="items"></div>
  <div class="pagination" id="pagination"></div>
</div>

<!-- ä¸Šæ¶å•†å“ -->
<div id="pageAdd" class="page">
  <div class="form-box">
    <h3>ä¸Šæ¶å•†å“</h3>

    <input id="name" placeholder="å•†å“åç¨±">
    <input id="price" type="number" min="1" placeholder="åƒ¹æ ¼">

    <select id="status">
      <option value="">è«‹é¸æ“‡ç‰©å“ç‹€æ…‹</option>
      <option>å…¨æ–°æœªæ‹†åŠç‰Œ</option>
      <option>æ‹†åŒ…è£æœ‰åŠç‰Œ</option>
      <option>æ™¯å“</option>
      <option>æœ‰æ±¡æã€é«’æ±¡</option>
      <option>å…¶ä»–ç‹€æ…‹ï¼ˆç§è¨Šäº†è§£ï¼‰</option>
    </select>

    <input id="seller" placeholder="è³£å®¶">
    <input id="contact" placeholder="è¯ç¹«æ–¹å¼">

    <!-- å–®å¼µåœ–ç‰‡ -->
    <input id="photo" type="file" accept="image/*">
    <small>ğŸ“Œ åƒ…é™ä¸Šå‚³ 1 å¼µåœ–ç‰‡ï¼ˆå»ºè­°å°æ–¼ 700KBï¼‰</small>

    <select id="place">
      <option>åœ‹å£½ä»æ„›å¤§æ¨“</option>
      <option>åœ‹å£½ä¿¡ç¾©å®‰å’Œå¤§æ¨“</option>
      <option>åœ‹å£½å…§æ¹–å¤§æ¨“</option>
      <option>éŠ€è¡Œæ¾ä»å¤§æ¨“</option>
      <option>è­‰åˆ¸æ•¦å—å¤§æ¨“</option>
      <option>å¦ç´„åœ°é»</option>
    </select>

    <button onclick="addItem()">ä¸Šæ¶</button>
  </div>
</div>

<div id="lightbox" onclick="this.style.display='none'">
  <img id="lightboxImg">
</div>

<script>
/* Firebase */
firebase.initializeApp({
  apiKey:"AIzaSyC-uOHBAqCsdZkvqisND_0JgR5govDqMZY",
  authDomain:"sale-chiikawa.firebaseapp.com",
  projectId:"sale-chiikawa"
});
const db=firebase.firestore();

/* ä½¿ç”¨è€…è­˜åˆ¥ï¼ˆåƒ…è‡ªå·±ä¸Šä¸‹æ¶ï¼‰ */
let myOwnerId=localStorage.getItem("ownerId");
if(!myOwnerId){
  myOwnerId="user_"+Math.random().toString(36).slice(2);
  localStorage.setItem("ownerId",myOwnerId);
}

/* åˆ†é  */
const ITEMS_PER_PAGE=20;
let allItems=[],filteredItems=[];

db.collection("items").orderBy("createdAt","desc").onSnapshot(s=>{
  allItems=[];
  s.forEach(d=>allItems.push({id:d.id,...d.data()}));
  applyFilter();
});

function applyFilter(){
  const n=searchName.value.toLowerCase();
  const s=searchSeller.value.toLowerCase();
  const st=filterStatus.value;
  filteredItems=allItems.filter(i=>
    i.name.toLowerCase().includes(n)&&
    i.seller.toLowerCase().includes(s)&&
    (st===""||i.status===st)
  );
  renderPage(1);
}

function renderPage(p){
  items.innerHTML="";
  filteredItems.slice((p-1)*ITEMS_PER_PAGE,p*ITEMS_PER_PAGE).forEach(i=>{
    items.innerHTML+=`
    <div class="card">
      <img src="${i.img}" onclick="openImg('${i.img}')">
      <p><b>å•†å“åç¨±ï¼š</b>${i.name}</p>
      <p><b>åƒ¹æ ¼ï¼š</b>$${i.price}</p>
      <p><b>ç‹€æ…‹ï¼š</b>${i.status}</p>
      <p><b>è³£å®¶ï¼š</b>${i.seller}</p>
      <p><b>è¯ç¹«æ–¹å¼ï¼š</b>${i.contact}</p>
      <p><b>åœ°é»ï¼š</b>${i.place}</p>
      ${i.ownerId===myOwnerId?`<button onclick="removeItem('${i.id}')">ä¸‹æ¶</button>`:""}
    </div>`;
  });
  pagination.innerHTML="";
  const pages=Math.ceil(filteredItems.length/ITEMS_PER_PAGE);
  for(let i=1;i<=pages;i++){
    pagination.innerHTML+=`<button onclick="renderPage(${i})">${i}</button>`;
  }
}

function addItem(){
  const name=document.getElementById("name");
  const price=document.getElementById("price");
  const status=document.getElementById("status");
  const seller=document.getElementById("seller");
  const contact=document.getElementById("contact");
  const place=document.getElementById("place");
  const photo=document.getElementById("photo");

  if(
    name.value.trim()===""||
    price.value===""||
    status.value===""||
    seller.value.trim()===""||
    contact.value.trim()===""||
    !photo.files[0]
  ){
    alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");return;
  }

  const file=photo.files[0];
  if(file.size>700*1024){
    alert("åœ–ç‰‡éœ€å°æ–¼ 700KB");return;
  }

  const reader=new FileReader();
  reader.onload=()=>{
    db.collection("items").add({
      name:name.value.trim(),
      price:Number(price.value),
      status:status.value,
      seller:seller.value.trim(),
      contact:contact.value.trim(),
      place:place.value,
      img:reader.result,
      ownerId:myOwnerId,
      createdAt:firebase.firestore.FieldValue.serverTimestamp()
    }).then(()=>{alert("ä¸Šæ¶æˆåŠŸ");switchPage("list")});
  };
  reader.readAsDataURL(file);
}

function removeItem(id){
  if(confirm("ç¢ºå®šä¸‹æ¶ï¼Ÿ")){
    db.collection("items").doc(id).delete();
  }
}

function openImg(src){
  lightboxImg.src=src;
  lightbox.style.display="flex";
}

function switchPage(p){
  pageList.classList.remove("active");
  pageAdd.classList.remove("active");
  tabList.classList.remove("active");
  tabAdd.classList.remove("active");
  if(p==="list"){pageList.classList.add("active");tabList.classList.add("active")}
  else{pageAdd.classList.add("active");tabAdd.classList.add("active")}
}
</script>

</body>
</html>
