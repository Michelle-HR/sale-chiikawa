<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>äºŒæ‰‹äº¤æ˜“å¹³å°</title>

  <!-- Firebase SDKï¼ˆcompat ç‰ˆï¼Œé©åˆ GitHub Pagesï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    .container {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .box {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      width: 48%;
      min-width: 300px;
    }
    input, select, button {
      width: 100%;
      margin-top: 8px;
      padding: 6px;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      background: #2c7be5;
      color: #fff;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #1a68d1;
    }
    small {
      color: #666;
      display: block;
      margin-top: 4px;
    }

    .item {
      border-bottom: 1px solid #ddd;
      margin-bottom: 14px;
      padding-bottom: 14px;
    }

    /* å•†å“åœ–ç‰‡ï¼ˆåˆ—è¡¨ï¼‰ */
    .image-preview {
      width: 100%;
      max-height: 200px;
      object-fit: contain;
      background: #f0f0f0;
      cursor: pointer;
      border-radius: 4px;
      margin-bottom: 6px;
    }

    /* Lightbox */
    #lightbox {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.8);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    #lightbox img {
      max-width: 90%;
      max-height: 90%;
      background: #fff;
      border-radius: 6px;
    }
  </style>
</head>

<body>

<h1>ğŸ›’ äºŒæ‰‹äº¤æ˜“ç¶²ç«™</h1>

<div class="container">

  <!-- ä¸Šæ¶å•†å“ -->
  <div class="box">
    <h3>ä¸Šæ¶å•†å“</h3>

    <input type="text" id="name" placeholder="å•†å“åç¨±">
    <input type="number" id="price" placeholder="åƒ¹æ ¼">
    <input type="text" id="seller" placeholder="è³£å®¶åå­—">
    <input type="text" id="contact" placeholder="è¯ç¹«æ–¹å¼ï¼ˆLine / Emailï¼‰">

    <input type="file" id="photo" accept="image/*">
    <small>ğŸ“Œ åœ–ç‰‡éœ€å°æ–¼ <b>700KB</b></small>

    <select id="place">
      <option>åœ‹å£½ä»æ„›å¤§æ¨“</option>
      <option>åœ‹å£½ä¿¡ç¾©å®‰å’Œå¤§æ¨“</option>
      <option>åœ‹å£½å…§æ¹–å¤§æ¨“</option>
      <option>éŠ€è¡Œæ¾ä»å¤§æ¨“</option>
      <option>è­‰åˆ¸æ•¦å—å¤§æ¨“</option>
    </select>

    <button onclick="addItem()">ä¸Šæ¶</button>
  </div>

  <!-- å•†å“åˆ—è¡¨ -->
  <div class="box">
    <h3>å•†å“åˆ—è¡¨</h3>
    <div id="items"></div>
  </div>

</div>

<!-- æ”¾å¤§åœ–ç‰‡ç”¨ -->
<div id="lightbox" onclick="closeLightbox()">
  <img id="lightboxImg">
</div>

<script>
/* ===== Firebase åˆå§‹åŒ– ===== */
const firebaseConfig = {
  apiKey: "AIzaSyC-uOHBAqCsdZkvqisND_0JgR5govDqMZY",
  authDomain: "sale-chiikawa.firebaseapp.com",
  projectId: "sale-chiikawa",
  storageBucket: "sale-chiikawa.appspot.com",
  messagingSenderId: "22981104406",
  appId: "1:22981104406:web:7c094b64fc1877c6d1f637"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const itemsBox = document.getElementById("items");

/* ===== ç”¢ç”Ÿ / å–å¾— ownerIdï¼ˆç„¡ç™»å…¥ï¼‰ ===== */
let myOwnerId = localStorage.getItem("ownerId");
if (!myOwnerId) {
  myOwnerId = "owner_" + Math.random().toString(36).slice(2);
  localStorage.setItem("ownerId", myOwnerId);
}

/* ===== åœ–ç‰‡æ”¾å¤§ ===== */
function openLightbox(src) {
  document.getElementById("lightboxImg").src = src;
  document.getElementById("lightbox").style.display = "flex";
}
function closeLightbox() {
  document.getElementById("lightbox").style.display = "none";
}

/* ===== ä¸Šæ¶å•†å“ ===== */
function addItem() {
  const name = document.getElementById("name").value.trim();
  const price = Number(document.getElementById("price").value);
  const seller = document.getElementById("seller").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const place = document.getElementById("place").value;
  const photoInput = document.getElementById("photo");

  if (!name || !price || !seller || !contact || !photoInput.files[0]) {
    alert("è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½");
    return;
  }

  const file = photoInput.files[0];
  const MAX_SIZE = 700 * 1024;
  if (file.size > MAX_SIZE) {
    alert("åœ–ç‰‡å¤ªå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 700KB çš„åœ–ç‰‡");
    photoInput.value = "";
    return;
  }

  const reader = new FileReader();
  reader.onload = function () {
    const base64 = reader.result;
    const estimatedBytes = Math.ceil(base64.length * 0.75);
    if (estimatedBytes > 1024 * 1024) {
      alert("åœ–ç‰‡è½‰æ›å¾Œè¶…é 1MBï¼Œè«‹ä½¿ç”¨æ›´å°åœ–ç‰‡");
      return;
    }

    db.collection("items").add({
      name,
      price,
      seller,
      contact,
      place,
      img: base64,
      ownerId: myOwnerId,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    }).then(() => {
      alert("âœ… å•†å“å·²ä¸Šæ¶");
      document.getElementById("name").value = "";
      document.getElementById("price").value = "";
      document.getElementById("seller").value = "";
      document.getElementById("contact").value = "";
      document.getElementById("photo").value = "";
    });
  };

  reader.readAsDataURL(file);
}

/* ===== ä¸‹æ¶å•†å“ ===== */
function removeItem(id) {
  if (!confirm("ç¢ºå®šè¦ä¸‹æ¶é€™å€‹å•†å“å—ï¼Ÿ")) return;
  db.collection("items").doc(id).delete();
}

/* ===== å³æ™‚é¡¯ç¤ºå•†å“ ===== */
db.collection("items")
  .orderBy("createdAt", "desc")
  .onSnapshot(snapshot => {
    itemsBox.innerHTML = "";
    snapshot.forEach(doc => {
      const i = doc.data();
      const isMine = i.ownerId === myOwnerId;

      itemsBox.innerHTML += `
        <div class="item">
          <img src="${i.img}" class="image-preview"
               onclick="openLightbox('${i.img}')">
          <b>${i.name}</b><br>
          åƒ¹æ ¼ï¼š$${i.price}<br>
          è³£å®¶ï¼š${i.seller}<br>
          è¯ç¹«æ–¹å¼ï¼š${i.contact}<br>
          äº¤æ˜“åœ°é»ï¼š${i.place}<br>
          ${isMine ? `<button onclick="removeItem('${doc.id}')">ä¸‹æ¶å•†å“</button>` : ""}
        </div>
      `;
    });
  });
</script>

</body>
</html>
